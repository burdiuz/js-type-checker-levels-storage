{"version":3,"file":"index.js","sources":["source/levels.js","source/storage.js"],"sourcesContent":["import hasOwn from '@actualwave/has-own';\n\n/**\n * Do not check or report type inconsistency\n */\nexport const REPORT_NEVER = 'never';\n/**\n * Report type inconsistency once, i.e. record all types and report new\n */\nexport const REPORT_ONCE = 'once';\n/**\n * Report whenever type is inconsistent with initial\n */\nexport const REPORT_ALL = 'all';\n\nconst REPORT_KEY = Symbol('type-checkers:report-level');\nconst PROPERTY_REPORT_KEY = Symbol('type-checkers:property-report-level');\n\nlet globalReportingLevel = REPORT_ALL;\n\nexport const validateReportingLevel = (level) => {\n  switch (level) {\n    case REPORT_NEVER:\n    case REPORT_ONCE:\n      return level;\n    default:\n      return REPORT_ALL;\n  }\n};\n\nexport const setGlobalReportingLevel = (level) => {\n  globalReportingLevel = validateReportingLevel(level);\n};\n\nexport const getGlobalReportingLevel = () => globalReportingLevel;\n\nconst setTargetGeneralReportingLevel = (target, level) => {\n  if (level) {\n    target[REPORT_KEY] = validateReportingLevel(level);\n  } else {\n    delete target[REPORT_KEY];\n  }\n};\n\nconst setTargetPropertyReportingLevel = (target, perPropertyLevels) => {\n  if (!perPropertyLevels) {\n    delete target[PROPERTY_REPORT_KEY];\n    return;\n  }\n\n  target[PROPERTY_REPORT_KEY] = Object.keys(perPropertyLevels).reduce(\n    (levels, prop) => {\n      levels[prop] = validateReportingLevel(perPropertyLevels[prop]);\n      return levels;\n    },\n    {}\n  );\n};\n\nexport const setReportingLevel = (target, generalLevel, perPropertyLevels) => {\n  setTargetGeneralReportingLevel(target, generalLevel);\n  setTargetPropertyReportingLevel(target, perPropertyLevels);\n};\n\nconst getTargetReportingLevel = (target, key) => {\n  if (hasOwn(target[PROPERTY_REPORT_KEY], key)) {\n    return target[PROPERTY_REPORT_KEY][key];\n  }\n\n  return target[REPORT_KEY];\n};\n\nexport const getReportingLevel = (target, key) => {\n  let level = getTargetReportingLevel(target, key);\n\n  if (!level) {\n    level = getTargetReportingLevel(target.constructor, key);\n  }\n\n  return level || getGlobalReportingLevel();\n};\n","import {\n  REPORT_NEVER,\n  REPORT_ONCE,\n  REPORT_ALL,\n  getReportingLevel,\n  validateReportingLevel,\n} from './levels';\n\n/**\n *\n * @param {any} key\n * @param {Set} target\n * @param {Set} source\n */\nconst defaultMergeStrategy = (key, target, source) => {\n  if (!source || !target) {\n    return source || target;\n  }\n\n  source.forEach((type) => {\n    if (!target.has(type)) {\n      target.add(type);\n    }\n  });\n\n  return target;\n};\n\nclass TypeInfoStorage {\n  constructor() {\n    this.storage = new Map();\n  }\n\n  has(key) {\n    const info = this.storage.get(key);\n\n    return info && info.size;\n  }\n\n  hasType(key, type) {\n    const info = this.storage.get(key);\n\n    return info && info.has(type);\n  }\n\n  /**\n   *\n   * @param {*} key\n   * @param {Function} callback\n   */\n  get(key, callback) {\n    const info = this.storage.get(key);\n\n    if (info) {\n      info.forEach((type) => callback(key, type));\n    }\n  }\n\n  /**\n   * Add to type information for specified key.\n   * @param {*} key\n   * @param {*} type\n   * @param {Number} level\n   */\n  add(key, type, level) {\n    if (!type) return;\n\n    switch (level) {\n      case REPORT_NEVER:\n        this.storage.delete(key);\n        break;\n      case REPORT_ONCE:\n        {\n          const types = this.storage.get(key);\n\n          if (types) {\n            if (!types.has(type)) {\n              types.add(type);\n            }\n          } else {\n            this.storage.set(key, new Set([type]));\n          }\n        }\n        break;\n      case REPORT_ALL:\n      default:\n        {\n          const types = this.storage.get(key);\n\n          if (!types || !types.size) {\n            this.storage.set(key, new Set([type]));\n          }\n        }\n        break;\n    }\n  }\n\n  addFor(key, type, target) {\n    this.add(key, type, getReportingLevel(target, key));\n  }\n\n  /**\n   * Replace types information for specific key\n   * @param {*} key\n   * @param {Set} types\n   * @param {Number} level\n   */\n  set(key, types, level) {\n    if (!types || types.size === 0 || level === REPORT_NEVER) {\n      this.storage.delete(key);\n      return;\n    }\n\n    this.storage.set(key, types);\n  }\n\n  /**\n   *\n   * @param {*} key\n   * @param {Set} types\n   * @param {Object} target\n   */\n  setFor(key, types, target) {\n    return this.set(key, types, getReportingLevel(target, key));\n  }\n\n  clone() {\n    const target = new TypeInfoStorage();\n    this.storage.forEach((types, key) => target.set(key, new Set(types)));\n\n    return target;\n  }\n\n  /**\n   * Copy types from current storage to storage passed as first argument.\n   * @param {Map} storage\n   * @param {Object} [target]\n   * @param {Function} [mergeStrategy]\n   */\n  copyTo(storage, target, mergeStrategy = defaultMergeStrategy) {\n    this.storage.forEach((types, key) => {\n      const level = validateReportingLevel(target && getReportingLevel(target, key));\n\n      switch (level) {\n        case REPORT_ALL:\n        case REPORT_ONCE:\n          if (storage.has(key)) {\n            storage.set(key, mergeStrategy(key, storage.get(key), types, level), level);\n          } else {\n            storage.set(key, new Set(types));\n          }\n          break;\n        case REPORT_NEVER:\n        default:\n          break;\n      }\n    });\n\n    return storage;\n  }\n}\n\nexport const createTypesStorage = () => new TypeInfoStorage();\n\nexport default TypeInfoStorage;\n"],"names":["REPORT_NEVER","REPORT_ONCE","REPORT_ALL","REPORT_KEY","Symbol","PROPERTY_REPORT_KEY","globalReportingLevel","validateReportingLevel","level","setGlobalReportingLevel","getGlobalReportingLevel","setTargetGeneralReportingLevel","target","setTargetPropertyReportingLevel","perPropertyLevels","Object","keys","reduce","levels","prop","setReportingLevel","generalLevel","getTargetReportingLevel","key","hasOwn","getReportingLevel","constructor","defaultMergeStrategy","source","forEach","type","has","add","TypeInfoStorage","storage","Map","info","get","size","callback","delete","types","set","Set","mergeStrategy","createTypesStorage"],"mappings":";;;;;;;;AAEA;;;AAGA,MAAaA,eAAe,OAArB;;;;AAIP,MAAaC,cAAc,MAApB;;;;AAIP,MAAaC,aAAa,KAAnB;;AAEP,MAAMC,aAAaC,OAAO,4BAAP,CAAnB;AACA,MAAMC,sBAAsBD,OAAO,qCAAP,CAA5B;;AAEA,IAAIE,uBAAuBJ,UAA3B;;AAEA,AAAO,MAAMK,yBAA0BC,KAAD,IAAW;UACvCA,KAAR;SACOR,YAAL;SACKC,WAAL;aACSO,KAAP;;aAEON,UAAP;;CANC;;AAUP,MAAaO,0BAA2BD,KAAD,IAAW;yBACzBD,uBAAuBC,KAAvB,CAAvB;CADK;;AAIP,MAAaE,0BAA0B,MAAMJ,oBAAtC;;AAEP,MAAMK,iCAAiC,CAACC,MAAD,EAASJ,KAAT,KAAmB;MACpDA,KAAJ,EAAW;WACFL,UAAP,IAAqBI,uBAAuBC,KAAvB,CAArB;GADF,MAEO;WACEI,OAAOT,UAAP,CAAP;;CAJJ;;AAQA,MAAMU,kCAAkC,CAACD,MAAD,EAASE,iBAAT,KAA+B;MACjE,CAACA,iBAAL,EAAwB;WACfF,OAAOP,mBAAP,CAAP;;;;SAIKA,mBAAP,IAA8BU,OAAOC,IAAP,CAAYF,iBAAZ,EAA+BG,MAA/B,CAC5B,CAACC,MAAD,EAASC,IAAT,KAAkB;WACTA,IAAP,IAAeZ,uBAAuBO,kBAAkBK,IAAlB,CAAvB,CAAf;WACOD,MAAP;GAH0B,EAK5B,EAL4B,CAA9B;CANF;;AAeA,MAAaE,oBAAoB,CAACR,MAAD,EAASS,YAAT,EAAuBP,iBAAvB,KAA6C;iCAC7CF,MAA/B,EAAuCS,YAAvC;kCACgCT,MAAhC,EAAwCE,iBAAxC;CAFK;;AAKP,MAAMQ,0BAA0B,CAACV,MAAD,EAASW,GAAT,KAAiB;MAC3CC,OAAOZ,OAAOP,mBAAP,CAAP,EAAoCkB,GAApC,CAAJ,EAA8C;WACrCX,OAAOP,mBAAP,EAA4BkB,GAA5B,CAAP;;;SAGKX,OAAOT,UAAP,CAAP;CALF;;AAQA,MAAasB,oBAAoB,CAACb,MAAD,EAASW,GAAT,KAAiB;MAC5Cf,QAAQc,wBAAwBV,MAAxB,EAAgCW,GAAhC,CAAZ;;MAEI,CAACf,KAAL,EAAY;YACFc,wBAAwBV,OAAOc,WAA/B,EAA4CH,GAA5C,CAAR;;;SAGKf,SAASE,yBAAhB;CAPK;;AChEP;;;;;;AAMA,MAAMiB,uBAAuB,CAACJ,GAAD,EAAMX,MAAN,EAAcgB,MAAd,KAAyB;MAChD,CAACA,MAAD,IAAW,CAAChB,MAAhB,EAAwB;WACfgB,UAAUhB,MAAjB;;;SAGKiB,OAAP,CAAgBC,IAAD,IAAU;QACnB,CAAClB,OAAOmB,GAAP,CAAWD,IAAX,CAAL,EAAuB;aACdE,GAAP,CAAWF,IAAX;;GAFJ;;SAMOlB,MAAP;CAXF;;AAcA,MAAMqB,eAAN,CAAsB;gBACN;SACPC,OAAL,GAAe,IAAIC,GAAJ,EAAf;;;MAGEZ,GAAJ,EAAS;UACDa,OAAO,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAb;;WAEOa,QAAQA,KAAKE,IAApB;;;UAGMf,GAAR,EAAaO,IAAb,EAAmB;UACXM,OAAO,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAb;;WAEOa,QAAQA,KAAKL,GAAL,CAASD,IAAT,CAAf;;;;;;;;MAQEP,GAAJ,EAASgB,QAAT,EAAmB;UACXH,OAAO,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAb;;QAEIa,IAAJ,EAAU;WACHP,OAAL,CAAcC,IAAD,IAAUS,SAAShB,GAAT,EAAcO,IAAd,CAAvB;;;;;;;;;;MAUAP,GAAJ,EAASO,IAAT,EAAetB,KAAf,EAAsB;QAChB,CAACsB,IAAL,EAAW;;YAEHtB,KAAR;WACOR,YAAL;aACOkC,OAAL,CAAaM,MAAb,CAAoBjB,GAApB;;WAEGtB,WAAL;;gBAEUwC,QAAQ,KAAKP,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAd;;cAEIkB,KAAJ,EAAW;gBACL,CAACA,MAAMV,GAAN,CAAUD,IAAV,CAAL,EAAsB;oBACdE,GAAN,CAAUF,IAAV;;WAFJ,MAIO;iBACAI,OAAL,CAAaQ,GAAb,CAAiBnB,GAAjB,EAAsB,IAAIoB,GAAJ,CAAQ,CAACb,IAAD,CAAR,CAAtB;;;;WAID5B,UAAL;;;gBAGUuC,QAAQ,KAAKP,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAd;;cAEI,CAACkB,KAAD,IAAU,CAACA,MAAMH,IAArB,EAA2B;iBACpBJ,OAAL,CAAaQ,GAAb,CAAiBnB,GAAjB,EAAsB,IAAIoB,GAAJ,CAAQ,CAACb,IAAD,CAAR,CAAtB;;;;;;;SAOHP,GAAP,EAAYO,IAAZ,EAAkBlB,MAAlB,EAA0B;SACnBoB,GAAL,CAAST,GAAT,EAAcO,IAAd,EAAoBL,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAApB;;;;;;;;;MASEA,GAAJ,EAASkB,KAAT,EAAgBjC,KAAhB,EAAuB;QACjB,CAACiC,KAAD,IAAUA,MAAMH,IAAN,KAAe,CAAzB,IAA8B9B,UAAUR,YAA5C,EAA0D;WACnDkC,OAAL,CAAaM,MAAb,CAAoBjB,GAApB;;;;SAIGW,OAAL,CAAaQ,GAAb,CAAiBnB,GAAjB,EAAsBkB,KAAtB;;;;;;;;;SASKlB,GAAP,EAAYkB,KAAZ,EAAmB7B,MAAnB,EAA2B;WAClB,KAAK8B,GAAL,CAASnB,GAAT,EAAckB,KAAd,EAAqBhB,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAArB,CAAP;;;UAGM;UACAX,SAAS,IAAIqB,eAAJ,EAAf;SACKC,OAAL,CAAaL,OAAb,CAAqB,CAACY,KAAD,EAAQlB,GAAR,KAAgBX,OAAO8B,GAAP,CAAWnB,GAAX,EAAgB,IAAIoB,GAAJ,CAAQF,KAAR,CAAhB,CAArC;;WAEO7B,MAAP;;;;;;;;;SASKsB,OAAP,EAAgBtB,MAAhB,EAAwBgC,gBAAgBjB,oBAAxC,EAA8D;SACvDO,OAAL,CAAaL,OAAb,CAAqB,CAACY,KAAD,EAAQlB,GAAR,KAAgB;YAC7Bf,QAAQD,uBAAuBK,UAAUa,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAAjC,CAAd;;cAEQf,KAAR;aACON,UAAL;aACKD,WAAL;cACMiC,QAAQH,GAAR,CAAYR,GAAZ,CAAJ,EAAsB;oBACZmB,GAAR,CAAYnB,GAAZ,EAAiBqB,cAAcrB,GAAd,EAAmBW,QAAQG,GAAR,CAAYd,GAAZ,CAAnB,EAAqCkB,KAArC,EAA4CjC,KAA5C,CAAjB,EAAqEA,KAArE;WADF,MAEO;oBACGkC,GAAR,CAAYnB,GAAZ,EAAiB,IAAIoB,GAAJ,CAAQF,KAAR,CAAjB;;;aAGCzC,YAAL;;;;KAZJ;;WAkBOkC,OAAP;;;;AAIJ,MAAaW,qBAAqB,MAAM,IAAIZ,eAAJ,EAAjC;;;;;;;;;;;"}