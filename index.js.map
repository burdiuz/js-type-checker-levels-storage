{"version":3,"file":"index.js","sources":["source/levels.js","source/storage.js"],"sourcesContent":["import hasOwn from '@actualwave/has-own';\n\n/**\n * Do not check or report type inconsistency\n */\nexport const REPORT_NEVER = 'never';\n/**\n * Report type inconsistency once, i.e. record all types and report new\n */\nexport const REPORT_ONCE = 'once';\n/**\n * Report whenever type is inconsistent with initial\n */\nexport const REPORT_ALL = 'all';\n\nconst REPORT_KEY = Symbol('type-checkers:report-level');\nconst PROPERTY_REPORT_KEY = Symbol('type-checkers:property-report-level');\n\nlet globalReportingLevel = REPORT_ALL;\n\nexport const validateReportingLevel = (level) => {\n  switch (level) {\n    case REPORT_NEVER:\n    case REPORT_ONCE:\n      return level;\n    default:\n      return REPORT_ALL;\n  }\n};\n\nexport const setGlobalReportingLevel = (level) => {\n  globalReportingLevel = validateReportingLevel(level);\n};\n\nexport const getGlobalReportingLevel = () => globalReportingLevel;\n\nconst setTargetGeneralReportingLevel = (target, level) => {\n  if (level) {\n    target[REPORT_KEY] = validateReportingLevel(level);\n  } else {\n    delete target[REPORT_KEY];\n  }\n};\n\nconst setTargetPropertyReportingLevel = (target, perPropertyLevels) => {\n  if (!perPropertyLevels) {\n    delete target[PROPERTY_REPORT_KEY];\n    return;\n  }\n\n  target[PROPERTY_REPORT_KEY] = Object.keys(perPropertyLevels).reduce(\n    (levels, prop) => {\n      levels[prop] = validateReportingLevel(perPropertyLevels[prop]);\n      return levels;\n    },\n    {}\n  );\n};\n\nexport const setReportingLevel = (target, generalLevel, perPropertyLevels) => {\n  setTargetGeneralReportingLevel(target, generalLevel);\n  setTargetPropertyReportingLevel(target, perPropertyLevels);\n};\n\nconst getTargetReportingLevel = (target, key) => {\n  if (hasOwn(target[PROPERTY_REPORT_KEY], key)) {\n    return target[PROPERTY_REPORT_KEY][key];\n  }\n\n  return target[REPORT_KEY];\n};\n\nexport const getReportingLevel = (target, key) => {\n  let level = getTargetReportingLevel(target, key);\n\n  if (!level) {\n    level = getTargetReportingLevel(target.constructor, key);\n  }\n\n  return level || getGlobalReportingLevel();\n};\n","import {\n  REPORT_NEVER,\n  REPORT_ONCE,\n  REPORT_ALL,\n  getReportingLevel,\n  validateReportingLevel,\n} from './levels';\n\n/**\n *\n * @param {any} key\n * @param {Set} target\n * @param {Set} source\n */\nexport const defaultMergeStrategy = (key, target, source) => {\n  source.forEach((type) => {\n    if (!target.has(type)) {\n      target.add(type);\n    }\n  });\n\n  return target;\n};\n\nclass MapOfSets {\n  constructor() {\n    this.storage = new Map();\n  }\n\n  has(key) {\n    const values = this.storage.get(key);\n\n    return values && values.size;\n  }\n\n  hasValue(key, value) {\n    const values = this.storage.get(key);\n\n    return values && values.has(value);\n  }\n\n  /**\n   * @param {*} key\n   */\n  get(key) {\n    return this.storage.get(key);\n  }\n\n  list(key) {\n    const values = this.storage.get(key);\n\n    return values ? Array.from(values) : [];\n  }\n\n  /**\n   * @param {Function} callback\n   */\n  forEach(callback) {\n    this.storage.forEach((values, key) => values.forEach((value) => callback(value, key, this)));\n  }\n\n  /**\n   * @param {*} key\n   * @param {Function} callback\n   */\n  eachValue(key, callback) {\n    const values = this.storage.get(key);\n\n    if (values) {\n      values.forEach((value) => callback(value, key, this));\n    }\n  }\n\n  /**\n   * Add to type information for specified key.\n   * @param {*} key\n   * @param {*} value\n   * @param {Number} level\n   */\n  add(key, value) {\n    if (!value) return;\n    const values = this.storage.get(key);\n\n    if (values) {\n      values.add(value);\n    } else {\n      this.storage.set(key, new Set([value]));\n    }\n  }\n\n  /**\n   * Replace values information for specific key\n   * @param {*} key\n   * @param {Set} types\n   * @param {Number} level\n   */\n  set(key, values) {\n    if (!values || values.size === 0) {\n      this.remove(key);\n      return;\n    }\n\n    this.storage.set(key, new Set(values));\n  }\n\n  remove(key) {\n    this.storage.delete(key);\n  }\n\n  removeValue(key, value) {\n    const values = this.storage.get(key);\n\n    if (values) {\n      values.delete(value);\n\n      if (!values.size) {\n        this.remove(key);\n      }\n    }\n  }\n\n  clone() {\n    const target = new MapOfSets();\n    this.storage.forEach((values, key) => target.set(key, new Set(values)));\n\n    return target;\n  }\n}\n\nclass TypeInfoStorage extends MapOfSets {\n  /**\n   * Add to type information for specified key.\n   * @param {*} key\n   * @param {*} type\n   * @param {Number} level\n   */\n  add(key, type, level) {\n    if (!type) return;\n\n    switch (level) {\n      case REPORT_NEVER:\n        this.remove(key);\n        break;\n      case REPORT_ONCE:\n        super.add(key, type);\n        break;\n      case REPORT_ALL:\n      default:\n        {\n          const types = this.storage.get(key);\n\n          if (!types || !types.size) {\n            this.storage.set(key, new Set([type]));\n          }\n        }\n        break;\n    }\n  }\n\n  addFor(key, type, target) {\n    this.add(key, type, getReportingLevel(target, key));\n  }\n\n  /**\n   * Replace types information for specific key\n   * @param {*} key\n   * @param {Set} types\n   * @param {Number} level\n   */\n  set(key, types, level) {\n    if (!types || types.size === 0 || level === REPORT_NEVER) {\n      this.remove(key);\n      return;\n    }\n\n    super.set(key, types);\n  }\n\n  /**\n   *\n   * @param {*} key\n   * @param {Set} types\n   * @param {Object} target\n   */\n  setFor(key, types, target) {\n    return this.set(key, types, getReportingLevel(target, key));\n  }\n\n  clone() {\n    const target = new TypeInfoStorage();\n    this.storage.forEach((types, key) => target.set(key, new Set(types)));\n\n    return target;\n  }\n\n  /**\n   * Copy types from current storage to storage passed as first argument.\n   * @param {Map} storage\n   * @param {Object} [target]\n   * @param {Function} [mergeStrategy]\n   */\n  copyTo(storage, target, mergeStrategy = defaultMergeStrategy) {\n    this.storage.forEach((types, key) => {\n      const level = validateReportingLevel(target && getReportingLevel(target, key));\n\n      switch (level) {\n        case REPORT_ALL:\n        case REPORT_ONCE:\n          if (storage.has(key)) {\n            storage.set(key, mergeStrategy(key, storage.get(key), types, level), level);\n          } else {\n            storage.set(key, new Set(types));\n          }\n          break;\n        case REPORT_NEVER:\n        default:\n          break;\n      }\n    });\n\n    return storage;\n  }\n}\n\nexport const createTypesStorage = () => new TypeInfoStorage();\n\nexport default TypeInfoStorage;\n"],"names":["REPORT_NEVER","REPORT_ONCE","REPORT_ALL","REPORT_KEY","Symbol","PROPERTY_REPORT_KEY","globalReportingLevel","validateReportingLevel","level","setGlobalReportingLevel","getGlobalReportingLevel","setTargetGeneralReportingLevel","target","setTargetPropertyReportingLevel","perPropertyLevels","Object","keys","reduce","levels","prop","setReportingLevel","generalLevel","getTargetReportingLevel","key","hasOwn","getReportingLevel","constructor","defaultMergeStrategy","source","forEach","type","has","add","MapOfSets","storage","Map","values","get","size","value","Array","from","callback","set","Set","remove","delete","TypeInfoStorage","types","mergeStrategy","createTypesStorage"],"mappings":";;;;;;;;AAEA;;;AAGA,MAAaA,eAAe,OAArB;;;;AAIP,MAAaC,cAAc,MAApB;;;;AAIP,MAAaC,aAAa,KAAnB;;AAEP,MAAMC,aAAaC,OAAO,4BAAP,CAAnB;AACA,MAAMC,sBAAsBD,OAAO,qCAAP,CAA5B;;AAEA,IAAIE,uBAAuBJ,UAA3B;;AAEA,AAAO,MAAMK,yBAA0BC,KAAD,IAAW;UACvCA,KAAR;SACOR,YAAL;SACKC,WAAL;aACSO,KAAP;;aAEON,UAAP;;CANC;;AAUP,MAAaO,0BAA2BD,KAAD,IAAW;yBACzBD,uBAAuBC,KAAvB,CAAvB;CADK;;AAIP,MAAaE,0BAA0B,MAAMJ,oBAAtC;;AAEP,MAAMK,iCAAiC,CAACC,MAAD,EAASJ,KAAT,KAAmB;MACpDA,KAAJ,EAAW;WACFL,UAAP,IAAqBI,uBAAuBC,KAAvB,CAArB;GADF,MAEO;WACEI,OAAOT,UAAP,CAAP;;CAJJ;;AAQA,MAAMU,kCAAkC,CAACD,MAAD,EAASE,iBAAT,KAA+B;MACjE,CAACA,iBAAL,EAAwB;WACfF,OAAOP,mBAAP,CAAP;;;;SAIKA,mBAAP,IAA8BU,OAAOC,IAAP,CAAYF,iBAAZ,EAA+BG,MAA/B,CAC5B,CAACC,MAAD,EAASC,IAAT,KAAkB;WACTA,IAAP,IAAeZ,uBAAuBO,kBAAkBK,IAAlB,CAAvB,CAAf;WACOD,MAAP;GAH0B,EAK5B,EAL4B,CAA9B;CANF;;AAeA,MAAaE,oBAAoB,CAACR,MAAD,EAASS,YAAT,EAAuBP,iBAAvB,KAA6C;iCAC7CF,MAA/B,EAAuCS,YAAvC;kCACgCT,MAAhC,EAAwCE,iBAAxC;CAFK;;AAKP,MAAMQ,0BAA0B,CAACV,MAAD,EAASW,GAAT,KAAiB;MAC3CC,OAAOZ,OAAOP,mBAAP,CAAP,EAAoCkB,GAApC,CAAJ,EAA8C;WACrCX,OAAOP,mBAAP,EAA4BkB,GAA5B,CAAP;;;SAGKX,OAAOT,UAAP,CAAP;CALF;;AAQA,MAAasB,oBAAoB,CAACb,MAAD,EAASW,GAAT,KAAiB;MAC5Cf,QAAQc,wBAAwBV,MAAxB,EAAgCW,GAAhC,CAAZ;;MAEI,CAACf,KAAL,EAAY;YACFc,wBAAwBV,OAAOc,WAA/B,EAA4CH,GAA5C,CAAR;;;SAGKf,SAASE,yBAAhB;CAPK;;AChEP;;;;;;AAMA,MAAaiB,uBAAuB,CAACJ,GAAD,EAAMX,MAAN,EAAcgB,MAAd,KAAyB;SACpDC,OAAP,CAAgBC,IAAD,IAAU;QACnB,CAAClB,OAAOmB,GAAP,CAAWD,IAAX,CAAL,EAAuB;aACdE,GAAP,CAAWF,IAAX;;GAFJ;;SAMOlB,MAAP;CAPK;;AAUP,MAAMqB,SAAN,CAAgB;gBACA;SACPC,OAAL,GAAe,IAAIC,GAAJ,EAAf;;;MAGEZ,GAAJ,EAAS;UACDa,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;WAEOa,UAAUA,OAAOE,IAAxB;;;WAGOf,GAAT,EAAcgB,KAAd,EAAqB;UACbH,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;WAEOa,UAAUA,OAAOL,GAAP,CAAWQ,KAAX,CAAjB;;;;;;MAMEhB,GAAJ,EAAS;WACA,KAAKW,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAP;;;OAGGA,GAAL,EAAU;UACFa,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;WAEOa,SAASI,MAAMC,IAAN,CAAWL,MAAX,CAAT,GAA8B,EAArC;;;;;;UAMMM,QAAR,EAAkB;SACXR,OAAL,CAAaL,OAAb,CAAqB,CAACO,MAAD,EAASb,GAAT,KAAiBa,OAAOP,OAAP,CAAgBU,KAAD,IAAWG,SAASH,KAAT,EAAgBhB,GAAhB,EAAqB,IAArB,CAA1B,CAAtC;;;;;;;YAOQA,GAAV,EAAemB,QAAf,EAAyB;UACjBN,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;QAEIa,MAAJ,EAAY;aACHP,OAAP,CAAgBU,KAAD,IAAWG,SAASH,KAAT,EAAgBhB,GAAhB,EAAqB,IAArB,CAA1B;;;;;;;;;;MAUAA,GAAJ,EAASgB,KAAT,EAAgB;QACV,CAACA,KAAL,EAAY;UACNH,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;QAEIa,MAAJ,EAAY;aACHJ,GAAP,CAAWO,KAAX;KADF,MAEO;WACAL,OAAL,CAAaS,GAAb,CAAiBpB,GAAjB,EAAsB,IAAIqB,GAAJ,CAAQ,CAACL,KAAD,CAAR,CAAtB;;;;;;;;;;MAUAhB,GAAJ,EAASa,MAAT,EAAiB;QACX,CAACA,MAAD,IAAWA,OAAOE,IAAP,KAAgB,CAA/B,EAAkC;WAC3BO,MAAL,CAAYtB,GAAZ;;;;SAIGW,OAAL,CAAaS,GAAb,CAAiBpB,GAAjB,EAAsB,IAAIqB,GAAJ,CAAQR,MAAR,CAAtB;;;SAGKb,GAAP,EAAY;SACLW,OAAL,CAAaY,MAAb,CAAoBvB,GAApB;;;cAGUA,GAAZ,EAAiBgB,KAAjB,EAAwB;UAChBH,SAAS,KAAKF,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAf;;QAEIa,MAAJ,EAAY;aACHU,MAAP,CAAcP,KAAd;;UAEI,CAACH,OAAOE,IAAZ,EAAkB;aACXO,MAAL,CAAYtB,GAAZ;;;;;UAKE;UACAX,SAAS,IAAIqB,SAAJ,EAAf;SACKC,OAAL,CAAaL,OAAb,CAAqB,CAACO,MAAD,EAASb,GAAT,KAAiBX,OAAO+B,GAAP,CAAWpB,GAAX,EAAgB,IAAIqB,GAAJ,CAAQR,MAAR,CAAhB,CAAtC;;WAEOxB,MAAP;;;;AAIJ,MAAMmC,eAAN,SAA8Bd,SAA9B,CAAwC;;;;;;;MAOlCV,GAAJ,EAASO,IAAT,EAAetB,KAAf,EAAsB;QAChB,CAACsB,IAAL,EAAW;;YAEHtB,KAAR;WACOR,YAAL;aACO6C,MAAL,CAAYtB,GAAZ;;WAEGtB,WAAL;cACQ+B,GAAN,CAAUT,GAAV,EAAeO,IAAf;;WAEG5B,UAAL;;;gBAGU8C,QAAQ,KAAKd,OAAL,CAAaG,GAAb,CAAiBd,GAAjB,CAAd;;cAEI,CAACyB,KAAD,IAAU,CAACA,MAAMV,IAArB,EAA2B;iBACpBJ,OAAL,CAAaS,GAAb,CAAiBpB,GAAjB,EAAsB,IAAIqB,GAAJ,CAAQ,CAACd,IAAD,CAAR,CAAtB;;;;;;;SAOHP,GAAP,EAAYO,IAAZ,EAAkBlB,MAAlB,EAA0B;SACnBoB,GAAL,CAAST,GAAT,EAAcO,IAAd,EAAoBL,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAApB;;;;;;;;;MASEA,GAAJ,EAASyB,KAAT,EAAgBxC,KAAhB,EAAuB;QACjB,CAACwC,KAAD,IAAUA,MAAMV,IAAN,KAAe,CAAzB,IAA8B9B,UAAUR,YAA5C,EAA0D;WACnD6C,MAAL,CAAYtB,GAAZ;;;;UAIIoB,GAAN,CAAUpB,GAAV,EAAeyB,KAAf;;;;;;;;;SASKzB,GAAP,EAAYyB,KAAZ,EAAmBpC,MAAnB,EAA2B;WAClB,KAAK+B,GAAL,CAASpB,GAAT,EAAcyB,KAAd,EAAqBvB,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAArB,CAAP;;;UAGM;UACAX,SAAS,IAAImC,eAAJ,EAAf;SACKb,OAAL,CAAaL,OAAb,CAAqB,CAACmB,KAAD,EAAQzB,GAAR,KAAgBX,OAAO+B,GAAP,CAAWpB,GAAX,EAAgB,IAAIqB,GAAJ,CAAQI,KAAR,CAAhB,CAArC;;WAEOpC,MAAP;;;;;;;;;SASKsB,OAAP,EAAgBtB,MAAhB,EAAwBqC,gBAAgBtB,oBAAxC,EAA8D;SACvDO,OAAL,CAAaL,OAAb,CAAqB,CAACmB,KAAD,EAAQzB,GAAR,KAAgB;YAC7Bf,QAAQD,uBAAuBK,UAAUa,kBAAkBb,MAAlB,EAA0BW,GAA1B,CAAjC,CAAd;;cAEQf,KAAR;aACON,UAAL;aACKD,WAAL;cACMiC,QAAQH,GAAR,CAAYR,GAAZ,CAAJ,EAAsB;oBACZoB,GAAR,CAAYpB,GAAZ,EAAiB0B,cAAc1B,GAAd,EAAmBW,QAAQG,GAAR,CAAYd,GAAZ,CAAnB,EAAqCyB,KAArC,EAA4CxC,KAA5C,CAAjB,EAAqEA,KAArE;WADF,MAEO;oBACGmC,GAAR,CAAYpB,GAAZ,EAAiB,IAAIqB,GAAJ,CAAQI,KAAR,CAAjB;;;aAGChD,YAAL;;;;KAZJ;;WAkBOkC,OAAP;;;;AAIJ,MAAagB,qBAAqB,MAAM,IAAIH,eAAJ,EAAjC;;;;;;;;;;;;"}